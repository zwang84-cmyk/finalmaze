<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labyrinth of Shadows</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        #startPage {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #startImage {
            display: block;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        #startClickArea {
            position: absolute;
            cursor: pointer;
        }

        /* Game Styles */
        #game {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #mazeImg {
            display: block;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        #mazeWrapper {
            position: relative;
            display: inline-block;
        }

        #character {
            position: absolute;
            width: 30px;
            height: auto;
            mix-blend-mode: screen;
        }

        #flashlightOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            background: #000;
            -webkit-mask-image: radial-gradient(circle at 0px 0px, transparent 0px, transparent 60px, rgba(0,0,0,0.3) 80px, rgba(0,0,0,0.7) 100px, black 120px);
            mask-image: radial-gradient(circle at 0px 0px, transparent 0px, transparent 60px, rgba(0,0,0,0.3) 80px, rgba(0,0,0,0.7) 100px, black 120px);
        }

        #flashlightOverlay.hidden {
            display: none;
        }

        #winScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #winScreen img {
            display: block;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div id="startPage">
        <img id="startImage" src="finalmaze/finalmaze/start.png" alt="Start Page" />
        <div id="startClickArea"></div>
    </div>

    <script>
        const startImage = document.getElementById('startImage');
        const clickArea = document.getElementById('startClickArea');

        function positionClickArea() {
            const img = startImage;
            const rect = img.getBoundingClientRect();

            // Calculate the displayed image dimensions
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;
            const displayedWidth = rect.width;
            const displayedHeight = rect.height;

            // Scale factor
            const scale = displayedWidth / naturalWidth;

            // "Start Exploration" text approximate position in original image
            // Based on the image, it's near the bottom center
            const textX = naturalWidth * 0.28;
            const textY = naturalHeight * 0.72;
            const textWidth = naturalWidth * 0.44;
            const textHeight = naturalHeight * 0.12;

            // Apply scaled position
            clickArea.style.left = (rect.left + textX * scale) + 'px';
            clickArea.style.top = (rect.top + textY * scale) + 'px';
            clickArea.style.width = (textWidth * scale) + 'px';
            clickArea.style.height = (textHeight * scale) + 'px';
        }

        startImage.onload = positionClickArea;
        window.addEventListener('resize', positionClickArea);

        clickArea.addEventListener('click', function() {
            // Remove start page and start game
            document.getElementById('startPage').remove();
            startGame();
        });

        function startGame() {
            // Create game elements
            const gameDiv = document.createElement('div');
            gameDiv.id = 'game';

            const mazeWrapper = document.createElement('div');
            mazeWrapper.id = 'mazeWrapper';

            const mazeImg = document.createElement('img');
            mazeImg.id = 'mazeImg';
            mazeImg.src = 'finalmaze/finalmaze/maze.png';
            mazeImg.alt = 'maze';

            const character = document.createElement('img');
            character.id = 'character';
            character.src = 'finalmaze/finalmaze/character.png';
            character.alt = 'Character';

            mazeWrapper.appendChild(mazeImg);
            mazeWrapper.appendChild(character);
            gameDiv.appendChild(mazeWrapper);
            document.body.appendChild(gameDiv);

            const overlay = document.createElement('div');
            overlay.id = 'flashlightOverlay';
            document.body.appendChild(overlay);

            // Wait for maze image to load, then initialize game with correct position
            mazeImg.onload = function() {
                initGame(character, overlay, mazeImg);
            };
        }

        function initGame(character, overlay, mazeImg) {
            const moveSpeed = 5;

            // Calculate character spawn position relative to displayed maze
            const mazeWidth = mazeImg.offsetWidth;
            const mazeHeight = mazeImg.offsetHeight;

            // Position at top-left corridor (percentage-based for scaling)
            let posX = Math.round(mazeWidth * 0.025);
            let posY = Math.round(mazeHeight * 0.035);

            character.style.left = posX + 'px';
            character.style.top = posY + 'px';

            // Define invisible exit zone at bottom-right (near the exit arrow)
            const exitZone = {
                x: mazeWidth * 0.96,
                y: mazeHeight * 0.88,
                width: mazeWidth * 0.04,
                height: mazeHeight * 0.10
            };

            let gameWon = false;

            const keysPressed = {};

            document.addEventListener('keydown', (e) => {
                keysPressed[e.key.toLowerCase()] = true;
            });

            document.addEventListener('keyup', (e) => {
                keysPressed[e.key.toLowerCase()] = false;
            });

            // Check if character intersects exit zone
            function checkWinCondition() {
                const charWidth = character.offsetWidth;
                const charHeight = character.offsetHeight;

                // Check if character center is within exit zone
                const charCenterX = posX + charWidth / 2;
                const charCenterY = posY + charHeight / 2;

                if (charCenterX >= exitZone.x &&
                    charCenterX <= exitZone.x + exitZone.width &&
                    charCenterY >= exitZone.y &&
                    charCenterY <= exitZone.y + exitZone.height) {
                    return true;
                }
                return false;
            }

            function triggerWin() {
                gameWon = true;

                // Hide game elements
                document.getElementById('game').style.display = 'none';
                overlay.style.display = 'none';

                // Show win screen
                const winScreen = document.createElement('div');
                winScreen.id = 'winScreen';
                const winImg = document.createElement('img');
                winImg.src = 'finalmaze/finalmaze/rightway.png';
                winImg.alt = 'You Win!';
                winScreen.appendChild(winImg);
                document.body.appendChild(winScreen);
            }

            function gameLoop() {
                if (gameWon) return;

                if (keysPressed['w']) {
                    posY -= moveSpeed;
                }
                if (keysPressed['s']) {
                    posY += moveSpeed;
                }
                if (keysPressed['a']) {
                    posX -= moveSpeed;
                }
                if (keysPressed['d']) {
                    posX += moveSpeed;
                }

                character.style.left = posX + 'px';
                character.style.top = posY + 'px';

                // Check win condition
                if (checkWinCondition()) {
                    triggerWin();
                    return;
                }

                requestAnimationFrame(gameLoop);
            }

            gameLoop();

            // Flashlight system
            let flashlightUses = 3;
            let flashlightActive = false;
            let flashlightTimer = null;
            let mouseX = 0;
            let mouseY = 0;

            function updateFlashlightPosition() {
                const maskValue = `radial-gradient(circle at ${mouseX}px ${mouseY}px, transparent 0px, transparent 60px, rgba(0,0,0,0.3) 80px, rgba(0,0,0,0.7) 100px, black 120px)`;
                overlay.style.webkitMaskImage = maskValue;
                overlay.style.maskImage = maskValue;
            }

            window.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                if (flashlightActive) {
                    updateFlashlightPosition();
                }
            });

            function startFlashlight() {
                if (flashlightUses <= 0 || flashlightActive) return;

                flashlightActive = true;
                overlay.classList.remove('hidden');
                updateFlashlightPosition();

                flashlightTimer = setTimeout(() => {
                    endFlashlight();
                }, 12000);
            }

            function endFlashlight() {
                flashlightActive = false;
                flashlightUses--;
                overlay.classList.add('hidden');
                if (flashlightTimer) {
                    clearTimeout(flashlightTimer);
                    flashlightTimer = null;
                }
            }

            // Press C to activate next flashlight
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'c' && !flashlightActive && flashlightUses > 0) {
                    startFlashlight();
                }
            });

            // Start flashlight immediately
            startFlashlight();
        }
    </script>
</body>
</html>
