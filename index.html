<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labyrinth of Shadows</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        #startPage {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #startImage {
            display: block;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        #startClickArea {
            position: absolute;
            cursor: pointer;
        }

        /* Game Styles */
        #game {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #mazeImg {
            display: block;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        #mazeWrapper {
            position: relative;
            display: inline-block;
        }

        #character {
            position: absolute;
            width: 30px;
            height: auto;
            mix-blend-mode: screen;
        }

        #flashlightOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            background: #000;
        }

        #flashlightOverlay.hidden .mainLight {
            display: none;
        }

        #flashlightSvg {
            position: absolute;
            width: 0;
            height: 0;
        }
    </style>
</head>
<body>
    <div id="startPage">
        <img id="startImage" src="finalmaze/finalmaze/start.png" alt="Start Page" />
        <div id="startClickArea"></div>
    </div>

    <script>
        const startImage = document.getElementById('startImage');
        const clickArea = document.getElementById('startClickArea');

        function positionClickArea() {
            const img = startImage;
            const rect = img.getBoundingClientRect();

            // Calculate the displayed image dimensions
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;
            const displayedWidth = rect.width;
            const displayedHeight = rect.height;

            // Scale factor
            const scale = displayedWidth / naturalWidth;

            // "Start Exploration" text approximate position in original image
            // Based on the image, it's near the bottom center
            const textX = naturalWidth * 0.28;
            const textY = naturalHeight * 0.72;
            const textWidth = naturalWidth * 0.44;
            const textHeight = naturalHeight * 0.12;

            // Apply scaled position
            clickArea.style.left = (rect.left + textX * scale) + 'px';
            clickArea.style.top = (rect.top + textY * scale) + 'px';
            clickArea.style.width = (textWidth * scale) + 'px';
            clickArea.style.height = (textHeight * scale) + 'px';
        }

        startImage.onload = positionClickArea;
        window.addEventListener('resize', positionClickArea);

        clickArea.addEventListener('click', function() {
            // Remove start page and start game
            document.getElementById('startPage').remove();
            startGame();
        });

        function startGame() {
            // Create game elements
            const gameDiv = document.createElement('div');
            gameDiv.id = 'game';

            const mazeWrapper = document.createElement('div');
            mazeWrapper.id = 'mazeWrapper';

            const mazeImg = document.createElement('img');
            mazeImg.id = 'mazeImg';
            mazeImg.src = 'finalmaze/finalmaze/maze.png';
            mazeImg.alt = 'maze';

            const character = document.createElement('img');
            character.id = 'character';
            character.src = 'finalmaze/finalmaze/character.png';
            character.alt = 'Character';

            mazeWrapper.appendChild(mazeImg);
            mazeWrapper.appendChild(character);
            gameDiv.appendChild(mazeWrapper);
            document.body.appendChild(gameDiv);

            // Create SVG mask for multiple flashlights
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.id = 'flashlightSvg';
            svg.setAttribute('xmlns', svgNS);

            const defs = document.createElementNS(svgNS, 'defs');

            // Blur filter for soft edges
            const filter = document.createElementNS(svgNS, 'filter');
            filter.id = 'blur';
            const feBlur = document.createElementNS(svgNS, 'feGaussianBlur');
            feBlur.setAttribute('stdDeviation', '25');
            filter.appendChild(feBlur);
            defs.appendChild(filter);

            // Smaller blur for anchor lights
            const filterSmall = document.createElementNS(svgNS, 'filter');
            filterSmall.id = 'blurSmall';
            const feBlurSmall = document.createElementNS(svgNS, 'feGaussianBlur');
            feBlurSmall.setAttribute('stdDeviation', '18');
            filterSmall.appendChild(feBlurSmall);
            defs.appendChild(filterSmall);

            // Mask definition
            const mask = document.createElementNS(svgNS, 'mask');
            mask.id = 'flashlightMask';

            // White background (shows black overlay = darkness)
            const rect = document.createElementNS(svgNS, 'rect');
            rect.setAttribute('width', '100%');
            rect.setAttribute('height', '100%');
            rect.setAttribute('fill', 'white');
            mask.appendChild(rect);

            // Main flashlight circle (black = hides overlay = light)
            const mainLight = document.createElementNS(svgNS, 'circle');
            mainLight.id = 'mainLight';
            mainLight.classList.add('mainLight');
            mainLight.setAttribute('r', '80');
            mainLight.setAttribute('fill', 'black');
            mainLight.setAttribute('filter', 'url(#blur)');
            mask.appendChild(mainLight);

            // Start anchor light (70% size)
            const startLight = document.createElementNS(svgNS, 'circle');
            startLight.id = 'startLight';
            startLight.setAttribute('r', '56');
            startLight.setAttribute('fill', 'black');
            startLight.setAttribute('filter', 'url(#blurSmall)');
            mask.appendChild(startLight);

            // Exit anchor light (70% size)
            const exitLight = document.createElementNS(svgNS, 'circle');
            exitLight.id = 'exitLight';
            exitLight.setAttribute('r', '56');
            exitLight.setAttribute('fill', 'black');
            exitLight.setAttribute('filter', 'url(#blurSmall)');
            mask.appendChild(exitLight);

            defs.appendChild(mask);
            svg.appendChild(defs);
            document.body.appendChild(svg);

            const overlay = document.createElement('div');
            overlay.id = 'flashlightOverlay';
            overlay.style.mask = 'url(#flashlightMask)';
            overlay.style.webkitMask = 'url(#flashlightMask)';
            document.body.appendChild(overlay);

            // Wait for maze image to load, then initialize game with correct position
            mazeImg.onload = function() {
                initGame(character, overlay, mazeImg, mainLight, startLight, exitLight);
            };
        }

        function initGame(character, overlay, mazeImg, mainLight, startLight, exitLight) {
            const moveSpeed = 5;

            // Calculate character spawn position relative to displayed maze
            const mazeWidth = mazeImg.offsetWidth;
            const mazeHeight = mazeImg.offsetHeight;
            const mazeRect = mazeImg.getBoundingClientRect();

            // Position at top-left corridor (percentage-based for scaling)
            let posX = Math.round(mazeWidth * 0.025);
            let posY = Math.round(mazeHeight * 0.035);

            character.style.left = posX + 'px';
            character.style.top = posY + 'px';

            // Calculate static anchor positions in screen coordinates
            // Start anchor: top-left inside maze
            const startAnchorX = mazeRect.left + mazeWidth * 0.04;
            const startAnchorY = mazeRect.top + mazeHeight * 0.05;

            // Exit anchor: bottom-right inside maze (near the arrow exit)
            const exitAnchorX = mazeRect.left + mazeWidth * 0.97;
            const exitAnchorY = mazeRect.top + mazeHeight * 0.92;

            // Position static anchor lights
            startLight.setAttribute('cx', startAnchorX);
            startLight.setAttribute('cy', startAnchorY);
            exitLight.setAttribute('cx', exitAnchorX);
            exitLight.setAttribute('cy', exitAnchorY);

            const keysPressed = {};

            document.addEventListener('keydown', (e) => {
                keysPressed[e.key.toLowerCase()] = true;
            });

            document.addEventListener('keyup', (e) => {
                keysPressed[e.key.toLowerCase()] = false;
            });

            function gameLoop() {
                if (keysPressed['w']) {
                    posY -= moveSpeed;
                }
                if (keysPressed['s']) {
                    posY += moveSpeed;
                }
                if (keysPressed['a']) {
                    posX -= moveSpeed;
                }
                if (keysPressed['d']) {
                    posX += moveSpeed;
                }

                character.style.left = posX + 'px';
                character.style.top = posY + 'px';

                requestAnimationFrame(gameLoop);
            }

            gameLoop();

            // Flashlight system
            let flashlightUses = 3;
            let flashlightActive = false;
            let flashlightTimer = null;
            let mouseX = 0;
            let mouseY = 0;

            function updateFlashlightPosition() {
                mainLight.setAttribute('cx', mouseX);
                mainLight.setAttribute('cy', mouseY);
            }

            window.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                if (flashlightActive) {
                    updateFlashlightPosition();
                }
            });

            function startFlashlight() {
                if (flashlightUses <= 0 || flashlightActive) return;

                flashlightActive = true;
                overlay.classList.remove('hidden');
                mainLight.style.display = '';
                updateFlashlightPosition();

                flashlightTimer = setTimeout(() => {
                    endFlashlight();
                }, 12000);
            }

            function endFlashlight() {
                flashlightActive = false;
                flashlightUses--;
                mainLight.style.display = 'none';
                if (flashlightTimer) {
                    clearTimeout(flashlightTimer);
                    flashlightTimer = null;
                }
            }

            // Press C to activate next flashlight
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'c' && !flashlightActive && flashlightUses > 0) {
                    startFlashlight();
                }
            });

            // Start flashlight immediately
            startFlashlight();
        }
    </script>
</body>
</html>
